services:
  mosquitto:
    container_name: fdmm-mosquitto
    image: eclipse-mosquitto:2.0.22
    restart: unless-stopped
    ports:
#      - "1883:1883"   # plain MQTT
      - "8883:8883"   # MQTT over TLS
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
      - ./mosquitto/certs:/mosquitto/certs

  # docker build --platform linux/amd64,linux/arm64 -t 1.5.0-alpha . -f .\docker\Dockerfile
  fdm-monster:
    container_name: fdm-monster
    image: fdmmonster/fdm-monster:2.0.2
    build:
      context: .
      dockerfile: docker/Dockerfile
    restart: unless-stopped
    deploy:
      restart_policy:
        delay: 5s
        window: 120s
    ports:
      - "4000:4000"
    environment:
      - MEDIA_PATH=/app/media
      - DATABASE_PATH=/app/database
    volumes:
      - fdmm-media:/app/media
      - fdmm-database:/app/database

  # This section requires an explict docker network that allows the container to
  #  utilize an IP directly on the host interface. Reference macvlan setup at
  #  https://docs.docker.com/engine/network/drivers/macvlan/ for details
  fdm-monster-mdns:
    container_name: fdm-monster-mdns
    profiles: [mdns]
    image: fdmmonster/fdm-monster:develop-mdns
    build:
      context: .
      dockerfile: docker/Dockerfile-mdns
    restart: unless-stopped
    deploy:
      restart_policy:
        delay: 5s
        #max_attempts: 3
        window: 120s
    networks:
      fdmm_docker_bridge: # rename to mach your config option below
        #ipv4_address: <REPLACE WITH IP ADDRESS> # Uncommend and set valid ip address
                                                 # As is uses next available address
                                                 # from macvln ip-range
                                                 # Refer to docker documentation
    volumes:
      - fdmm-media:/app/media
      - fdmm-database:/app/database

  fdm-monster-develop:
    container_name: fdm-monster-develop
    profiles: [develop]
    image: fdmmonster/fdm-monster:develop
    build:
      context: .
      dockerfile: docker/Dockerfile
    restart: unless-stopped
    deploy:
      restart_policy:
        delay: 5s
        window: 120s
    ports:
      - "4001:4001"
    environment:
      - NODE_ENV=development
      - SERVER_PORT=4001
      - MEDIA_PATH=/app/media
      - DATABASE_PATH=/app/database
    volumes:
      - ./fdm-monster-alpha/media/:/app/media
      - ./fdm-monster-alpha/database/:/app/database

volumes:
  fdmm-media:
    name: fdmm-media
  fdmm-database:
    name: fdmm-database

networks:
  fdmm_docker_bridge:   # edit to suite as this is internal config
    external: true
    name: fdmm_docker_bridge # must match your macvlan bridge name
